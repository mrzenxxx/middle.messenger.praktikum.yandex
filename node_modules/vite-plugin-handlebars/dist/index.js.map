{"version":3,"file":"index.js","sources":["../src/context.ts","../src/partials.ts","../src/index.ts"],"sourcesContent":["export type Context =\n  | Record<string, unknown>\n  | ((path: string) => Record<string, unknown>)\n  | ((path: string) => Promise<Record<string, unknown>>);\n\nexport async function resolveContext(\n  context: Context | undefined,\n  pagePath: string\n): Promise<Record<string, unknown> | undefined> {\n  if (typeof context === 'undefined') {\n    return context;\n  }\n\n  if (typeof context === 'function') {\n    return resolveContext(await context(pagePath), pagePath);\n  }\n\n  const output: Record<string, unknown> = {};\n\n  for (const key of Object.keys(context)) {\n    const value = context[key];\n\n    if (typeof value === 'function') {\n      output[key] = await value(pagePath);\n    } else {\n      output[key] = value;\n    }\n  }\n\n  return output;\n}\n","import { registerPartial } from 'handlebars';\nimport { opendir, readFile } from 'fs/promises';\nimport { normalizePath } from 'vite';\nimport { join, parse } from 'path';\n\nconst VALID_EXTENSIONS = new Set(['.html', '.hbs']);\n\n// Borrowed from https://gist.github.com/lovasoa/8691344\nasync function* walk(dir: string): AsyncGenerator<string> {\n  for await (const d of await opendir(dir)) {\n    const fullFileName = join(dir, d.name);\n\n    if (d.isDirectory()) {\n      yield* walk(fullFileName);\n    } else if (d.isFile()) {\n      yield fullFileName;\n    }\n  }\n}\n\n/**\n * Registers each HTML file in a directory as Handlebars partial\n */\nexport async function registerPartials(\n  directoryPath: string | Array<string>,\n  partialsSet: Set<string>\n): Promise<void> {\n  const pathArray: Array<string> = Array.isArray(directoryPath) ? directoryPath : [directoryPath];\n\n  for await (const path of pathArray) {\n    try {\n      const normalizedPath = normalizePath(path);\n\n      for await (const fileName of walk(path)) {\n        const normalizedFileName = normalizePath(fileName);\n        const parsedPath = parse(normalizedFileName);\n\n        if (VALID_EXTENSIONS.has(parsedPath.ext)) {\n          let partialName = parsedPath.name;\n\n          if (parsedPath.dir !== normalizedPath) {\n            const prefix = parsedPath.dir.replace(`${normalizedPath}/`, '');\n            partialName = `${prefix}/${parsedPath.name}`;\n          }\n\n          const content = await readFile(fileName);\n\n          partialsSet.add(fileName);\n\n          registerPartial(partialName, content.toString());\n        }\n      }\n    } catch (e) {\n      // This error indicates the partial directory doesn't exist; ignore it\n      if (e.code !== 'ENOENT') {\n        throw e;\n      }\n    }\n  }\n}\n","import { compile, registerHelper, HelperDeclareSpec, RuntimeOptions } from 'handlebars';\nimport { resolve } from 'path';\nimport { IndexHtmlTransformContext, Plugin as VitePlugin, normalizePath } from 'vite';\nimport { Context, resolveContext } from './context';\nimport { registerPartials } from './partials';\n\ntype CompileArguments = Parameters<typeof compile>;\ntype CompileOptions = CompileArguments[1];\n\nexport interface HandlebarsPluginConfig {\n  context?: Context;\n  reloadOnPartialChange?: boolean;\n  compileOptions?: CompileOptions;\n  runtimeOptions?: RuntimeOptions;\n  partialDirectory?: string | Array<string>;\n  helpers?: HelperDeclareSpec;\n}\n\nexport default function handlebars({\n  context,\n  reloadOnPartialChange = true,\n  compileOptions,\n  runtimeOptions,\n  partialDirectory,\n  helpers,\n}: HandlebarsPluginConfig = {}): VitePlugin {\n  // Keep track of what partials are registered\n  const partialsSet = new Set<string>();\n\n  let root: string;\n\n  registerHelper('resolve-from-root', function (path) {\n    return resolve(root, path);\n  });\n\n  if (helpers) {\n    registerHelper(helpers);\n  }\n\n  return {\n    name: 'handlebars',\n\n    configResolved(config) {\n      root = config.root;\n    },\n\n    async handleHotUpdate({ server, file }) {\n      if (reloadOnPartialChange && partialsSet.has(file)) {\n        server.ws.send({\n          type: 'full-reload',\n        });\n\n        return [];\n      }\n    },\n\n    transformIndexHtml: {\n      // Ensure Handlebars runs _before_ any bundling\n      enforce: 'pre',\n\n      async transform(html: string, ctx: IndexHtmlTransformContext): Promise<string> {\n        if (partialDirectory) {\n          await registerPartials(partialDirectory, partialsSet);\n        }\n\n        const template = compile(html, compileOptions);\n\n        const resolvedContext = await resolveContext(context, normalizePath(ctx.path));\n        const result = template(resolvedContext, runtimeOptions);\n\n        return result;\n      },\n    },\n  };\n}\n"],"names":["resolveContext","context","pagePath","output","key","Object","keys","value","VALID_EXTENSIONS","Set","walk","dir","opendir","d","fullFileName","join","name","isDirectory","isFile","registerPartials","directoryPath","partialsSet","pathArray","Array","isArray","path","normalizedPath","normalizePath","fileName","normalizedFileName","parsedPath","parse","has","ext","partialName","prefix","replace","content","readFile","add","registerPartial","toString","e","code","handlebars","reloadOnPartialChange","compileOptions","runtimeOptions","partialDirectory","helpers","root","registerHelper","resolve","configResolved","config","handleHotUpdate","server","file","ws","send","type","transformIndexHtml","enforce","transform","html","ctx","template","compile","resolvedContext","result"],"mappings":";;;;;AAKO,eAAeA,cAAf,CACLC,OADK,EAELC,QAFK;AAIL,MAAI,OAAOD,OAAP,KAAmB,WAAvB,EAAoC;AAClC,WAAOA,OAAP;AACD;;AAED,MAAI,OAAOA,OAAP,KAAmB,UAAvB,EAAmC;AACjC,WAAOD,cAAc,CAAC,MAAMC,OAAO,CAACC,QAAD,CAAd,EAA0BA,QAA1B,CAArB;AACD;;AAED,QAAMC,MAAM,GAA4B,EAAxC;;AAEA,OAAK,MAAMC,GAAX,IAAkBC,MAAM,CAACC,IAAP,CAAYL,OAAZ,CAAlB,EAAwC;AACtC,UAAMM,KAAK,GAAGN,OAAO,CAACG,GAAD,CAArB;;AAEA,QAAI,OAAOG,KAAP,KAAiB,UAArB,EAAiC;AAC/BJ,MAAAA,MAAM,CAACC,GAAD,CAAN,GAAc,MAAMG,KAAK,CAACL,QAAD,CAAzB;AACD,KAFD,MAEO;AACLC,MAAAA,MAAM,CAACC,GAAD,CAAN,GAAcG,KAAd;AACD;AACF;;AAED,SAAOJ,MAAP;AACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzBD,MAAMK,gBAAgB,GAAG,IAAIC,GAAJ,CAAQ,CAAC,OAAD,EAAU,MAAV,CAAR,CAAzB;;SAGgBC;;;AAYhB;;;;;;8BAZA,WAAqBC,GAArB;;;;;;;AACE,qEAA4BC,gBAAO,CAACD,GAAD,CAAnC,iOAA0C;AAAA,cAAzBE,CAAyB;AACxC,cAAMC,YAAY,GAAGC,SAAI,CAACJ,GAAD,EAAME,CAAC,CAACG,IAAR,CAAzB;;AAEA,YAAIH,CAAC,CAACI,WAAF,EAAJ,EAAqB;AACnB,wDAAOP,IAAI,CAACI,YAAD,CAAX;AACD,SAFD,MAEO,IAAID,CAAC,CAACK,MAAF,EAAJ,EAAgB;AACrB,gBAAMJ,YAAN;AACD;AACF;;;;;;;;;;;;;;;AACF;;;;AAKM,eAAeK,gBAAf,CACLC,aADK,EAELC,WAFK;AAIL,QAAMC,SAAS,GAAkBC,KAAK,CAACC,OAAN,CAAcJ,aAAd,IAA+BA,aAA/B,GAA+C,CAACA,aAAD,CAAhF;;;;;;;AAEA,yCAAyBE,SAAzB,8LAAoC;AAAA,YAAnBG,MAAmB;;AAClC,UAAI;AACF,cAAMC,cAAc,GAAGC,kBAAa,CAACF,MAAD,CAApC;AADE;AAAA;;AAAA;;AAAA;AAGF,+CAA6Bf,IAAI,CAACe,MAAD,CAAjC,8LAAyC;AAAA,kBAAxBG,QAAwB;AACvC,kBAAMC,kBAAkB,GAAGF,kBAAa,CAACC,QAAD,CAAxC;AACA,kBAAME,UAAU,GAAGC,UAAK,CAACF,kBAAD,CAAxB;;AAEA,gBAAIrB,gBAAgB,CAACwB,GAAjB,CAAqBF,UAAU,CAACG,GAAhC,CAAJ,EAA0C;AACxC,kBAAIC,WAAW,GAAGJ,UAAU,CAACd,IAA7B;;AAEA,kBAAIc,UAAU,CAACnB,GAAX,KAAmBe,cAAvB,EAAuC;AACrC,sBAAMS,MAAM,GAAGL,UAAU,CAACnB,GAAX,CAAeyB,OAAf,IAA0BV,iBAA1B,EAA6C,EAA7C,CAAf;AACAQ,gBAAAA,WAAW,MAAMC,UAAUL,UAAU,CAACd,MAAtC;AACD;;AAED,oBAAMqB,OAAO,GAAG,MAAMC,iBAAQ,CAACV,QAAD,CAA9B;AAEAP,cAAAA,WAAW,CAACkB,GAAZ,CAAgBX,QAAhB;AAEAY,cAAAA,4BAAe,CAACN,WAAD,EAAcG,OAAO,CAACI,QAAR,EAAd,CAAf;AACD;AACF;AArBC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAsBH,OAtBD,CAsBE,OAAOC,CAAP,EAAU;AACV;AACA,YAAIA,CAAC,CAACC,IAAF,KAAW,QAAf,EAAyB;AACvB,gBAAMD,CAAN;AACD;AACF;AACF;;;;;;;;;;;;;;;AACF;;SCzCuBE,WAAW;AACjC3C,EAAAA,OADiC;AAEjC4C,EAAAA,qBAAqB,GAAG,IAFS;AAGjCC,EAAAA,cAHiC;AAIjCC,EAAAA,cAJiC;AAKjCC,EAAAA,gBALiC;AAMjCC,EAAAA;AANiC,IAOP;AAC1B;AACA,QAAM5B,WAAW,GAAG,IAAIZ,GAAJ,EAApB;AAEA,MAAIyC,IAAJ;AAEAC,EAAAA,2BAAc,CAAC,mBAAD,EAAsB,UAAU1B,MAAV;AAClC,WAAO2B,YAAO,CAACF,IAAD,EAAOzB,MAAP,CAAd;AACD,GAFa,CAAd;;AAIA,MAAIwB,OAAJ,EAAa;AACXE,IAAAA,2BAAc,CAACF,OAAD,CAAd;AACD;;AAED,SAAO;AACLjC,IAAAA,IAAI,EAAE,YADD;;AAGLqC,IAAAA,cAAc,CAACC,MAAD;AACZJ,MAAAA,IAAI,GAAGI,MAAM,CAACJ,IAAd;AACD,KALI;;AAOL,UAAMK,eAAN,CAAsB;AAAEC,MAAAA,MAAF;AAAUC,MAAAA;AAAV,KAAtB;AACE,UAAIZ,qBAAqB,IAAIxB,WAAW,CAACW,GAAZ,CAAgByB,IAAhB,CAA7B,EAAoD;AAClDD,QAAAA,MAAM,CAACE,EAAP,CAAUC,IAAV,CAAe;AACbC,UAAAA,IAAI,EAAE;AADO,SAAf;AAIA,eAAO,EAAP;AACD;AACF,KAfI;;AAiBLC,IAAAA,kBAAkB,EAAE;AAClB;AACAC,MAAAA,OAAO,EAAE,KAFS;;AAIlB,YAAMC,SAAN,CAAgBC,IAAhB,EAA8BC,GAA9B;AACE,YAAIjB,gBAAJ,EAAsB;AACpB,gBAAM7B,gBAAgB,CAAC6B,gBAAD,EAAmB3B,WAAnB,CAAtB;AACD;;AAED,cAAM6C,QAAQ,GAAGC,oBAAO,CAACH,IAAD,EAAOlB,cAAP,CAAxB;AAEA,cAAMsB,eAAe,GAAG,MAAMpE,cAAc,CAACC,OAAD,EAAU0B,kBAAa,CAACsC,GAAG,CAACxC,IAAL,CAAvB,CAA5C;AACA,cAAM4C,MAAM,GAAGH,QAAQ,CAACE,eAAD,EAAkBrB,cAAlB,CAAvB;AAEA,eAAOsB,MAAP;AACD;;AAfiB;AAjBf,GAAP;AAmCD;;;;"}